package org.trainman.servlet;

import org.trainman.dao.EmployeeDao;
import org.trainman.model.Employee;
import org.trainman.service.util.ExcelParser;
import org.trainman.service.util.ValidationUtil;

import javax.servlet.ServletException;
import javax.servlet.annotation.MultipartConfig;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.*;
import java.io.IOException;
import java.util.*;

@WebServlet("/upload")
@MultipartConfig(
    fileSizeThreshold = 1024 * 1024,  // 1 MB
    maxFileSize = 1024 * 1024 * 10,   // 10 MB
    maxRequestSize = 1024 * 1024 * 15  // 15 MB
)
public class UploadServlet extends HttpServlet {
    private final EmployeeDao dao = new EmployeeDao();
    
    @Override
    protected void doGet(HttpServletRequest req, HttpServletResponse resp) 
            throws ServletException, IOException {
        req.getRequestDispatcher("/jsp/upload.jsp").forward(req, resp);
    }
    
    private void logError(StringBuilder log, String empId, String error) {
        log.append("EMPID ").append(empId != null ? empId : "Unknown")
           .append(": ").append(error).append("\n");
    }
    
    @Override
    protected void doPost(HttpServletRequest req, HttpServletResponse resp) 
            throws ServletException, IOException {
        StringBuilder log = new StringBuilder();
        StringBuilder summary = new StringBuilder();
        int inserted = 0;
        int updated = 0;
        int failed = 0;
        List<String> updatedEmpIds = new ArrayList<>();
        boolean updateExisting = Boolean.parseBoolean(req.getParameter("updateExisting"));
        
        try {
            Part filePart = req.getPart("file");
            if (filePart == null || filePart.getSize() == 0) {
                req.setAttribute("errorLog", "No file uploaded");
                req.getRequestDispatcher("/jsp/upload.jsp").forward(req, resp);
                return;
            }

            String fileName = filePart.getSubmittedFileName();
            if (!fileName.toLowerCase().endsWith(".xlsx")) {
                req.setAttribute("errorLog", "Please upload an Excel file (.xlsx)");
                req.getRequestDispatcher("/jsp/upload.jsp").forward(req, resp);
                return;
            }

            // Use the positional parser since your Excel files follow the exact template order:
            // 0=EMP_ID,1=NAME,2=GENDER,3=DOJ,4=NSBT_BATCH_NO,5=STATUS,6=GRADE,7=BU,8=MPR_NO,9=IO_NAME,10=RELEASED_DATE,11=RESIGNATION_DATE
            org.trainman.service.util.ExcelParser.ParseResult parseResult;
            try {
                parseResult = ExcelParser.parse(filePart.getInputStream());
            } catch (Exception pe) {
                req.setAttribute("errorLog", "Failed to parse Excel file: " + pe.getMessage());
                req.getRequestDispatcher("/jsp/upload.jsp").forward(req, resp);
                return;
            }

            if (parseResult.getErrors() != null && !parseResult.getErrors().isEmpty()) {
                // Show mapping/diagnostic + any validation issues
                req.setAttribute("errorLog", String.join("\n", parseResult.getErrors()));
                req.getRequestDispatcher("/jsp/upload.jsp").forward(req, resp);
                return;
            }

            if (parseResult.getEmployees() == null || parseResult.getEmployees().isEmpty()) {
                req.setAttribute("errorLog", "No valid records found in the file");
                req.getRequestDispatcher("/jsp/upload.jsp").forward(req, resp);
                return;
            }

            // Process parsed employees
            for (Employee employee : parseResult.getEmployees()) {
                try {
                    // Server-side validation: ensure employee obeys business rules before DB operations
                    List<String> rowValidation = ValidationUtil.validate(employee);
                    if (rowValidation != null && !rowValidation.isEmpty()) {
                        failed++;
                        logError(log, employee.getEmpId(), "Validation failed: " + String.join(", ", rowValidation));
                        continue;
                    }
                    Employee existing = dao.findByEmpId(employee.getEmpId());
                    if (existing != null) {
                        if (updateExisting) {
                            // Update existing employee (Employee primary key is empId)
                            dao.update(employee);
                            updated++;
                            updatedEmpIds.add(employee.getEmpId());
                        } else {
                            logError(log, employee.getEmpId(), "Record already exists");
                            failed++;
                        }
                    } else {
                        dao.insert(employee);
                        inserted++;
                    }
                } catch (Exception e) {
                    failed++;
                    logError(log, employee.getEmpId(), e.getMessage());
                }
            }

        } catch (Exception ex) {
            logError(log, null, "Error processing file: " + ex.getMessage());
            failed++;
        }

        // Build summary message
        summary.append(String.format("Upload Results:\n"));
        summary.append(String.format("Inserted: %d | Updated: %d | Failed: %d\n",
            inserted, updated, failed));

        if (!updatedEmpIds.isEmpty()) {
            summary.append("Updated EMPIDs: ")
                  .append(String.join(", ", updatedEmpIds))
                  .append("\n");
        }

        if (inserted > 0) {
            summary.append("Successfully inserted ").append(inserted).append(" new records\n");
        }

        if (log.length() > 0) {
            summary.append("\nDetails:\n").append(log);
        }

        req.setAttribute(failed > 0 ? "errorLog" : "message", summary.toString());
        req.getRequestDispatcher("/jsp/upload.jsp").forward(req, resp);
    }
}

